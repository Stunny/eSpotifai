package main;

import view.AddMusicWindow;
import view.FollowersWindow;
import view.MainWindow;
import view.StatisticsWindow;

import javax.swing.JOptionPane;
import javax.swing.SwingUtilities;

import controller.ButtonsController;
import controller.GeneralController;
import controller.NetworkController;
import controller.PopUpController;
import customExceptions.DatabaseNotLoadedException;
import database.DDBBConnection;
import model.ManagementConfiguration;
import model.ServerConfiguration;
import network.Server;
import threads.RefreshThread;

public class Main {

	public static void main(String[] args) {
		/*
		DDBBConnection ddbbConnection = new DDBBConnection ("root", "", "espotyfai", 3306);
		try {
			//Creem la DDBB
			ddbbConnection.startConnection();
			ManagementConfiguration mc = new ManagementConfiguration();
			mc.runConfiguration();
			
			// Creem la VISTA
			MainWindow mainWindow = new MainWindow();
			AddMusicWindow addView = new AddMusicWindow();
			
			//Creem el CONTROLADOR
			ButtonsController buttonscontroller = new ButtonsController(mainWindow, ddbbConnection, addView);
			PopUpController popupcontroller = new PopUpController (mainWindow,ddbbConnection);
			GeneralController controller = new GeneralController (ddbbConnection, mainWindow);
			
			addView.registerControllerAdd(buttonscontroller);
			mainWindow.registerController(buttonscontroller, popupcontroller);
			mainWindow.setVisible(true);
			controller.run();
			
			
			/*
			 	StatisticsWindow statisticsWindow = new StatisticsWindow();
			 	statisticsWindow.setVisible(true);
			*/
			/*
			ddbbConnection.stopConnection();
			
		} catch (DatabaseNotLoadedException e) {
			System.out.println(e.getMessage());
		}
		
*/

		SwingUtilities.invokeLater(new Runnable() {
			@Override
			public void run() {
				try {
					ManagementConfiguration mc = new ManagementConfiguration();
					mc.runConfiguration();
					ServerConfiguration sc = mc.getServerConfiguration();

					DDBBConnection ddbbConnection = new DDBBConnection(sc.getUserBBDD(), sc.getPasswordBBDD(), sc.getNameBBDD(), sc.getPortConexionBBDD());
					ddbbConnection.startConnection();

					// Creem la VISTA

					MainWindow mainWindow = new MainWindow();
					AddMusicWindow addView = new AddMusicWindow();
					ButtonsController buttonscontroller = new ButtonsController(mainWindow, ddbbConnection, addView);
					PopUpController popupcontroller = new PopUpController (mainWindow,ddbbConnection);
					GeneralController controller = new GeneralController (ddbbConnection, mainWindow);
					
					mainWindow.registerController(buttonscontroller, popupcontroller);
					
					mainWindow.setVisible(true);


					StatisticsWindow statisticsWindow = new StatisticsWindow();
					//statisticsWindow.setVisible(true);

					(new RefreshThread(controller)).start();
					//controller.run();
					Server server = new Server(new NetworkController(ddbbConnection));
					server.startServer();


					//ddbbConnection.stopConnection();


				} catch (DatabaseNotLoadedException e) {
					JOptionPane.showMessageDialog(null, "No s'ha pogut accedir a la base de dades.", " ", JOptionPane.ERROR_MESSAGE);
				} catch (Exception e) {
					JOptionPane.showMessageDialog(null, "Hi ha hagut un error.", " ", JOptionPane.ERROR_MESSAGE);
				}
			}
		});
	}
}
